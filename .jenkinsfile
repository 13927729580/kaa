library 'kaaiot.shared-libraries@master'

gitlabUtils.populateEnvVariables()

pipeline {
  environment {
    TAG = gitlabUtils.getBuildTag()
    SERVICE_NAME = "kaa"
    SERVICE_NAME_UPPER = SERVICE_NAME.toUpperCase()
  }

  options {
    disableConcurrentBuilds()
    timeout(time: 30, unit: 'MINUTES')
  }

  agent none

  stages {
    stage ('Docs') {
      agent { label "docs-builder_v1" }

      steps {
        // Workaround to prevent Jekver from building tags.
        // Since doc generation flow will be changed really soon, I see no point
        // in investing time in this right now
        sh 'git tag | xargs git tag -d'

        container ('builder') {
          script {
            docs.publish(env.SERVICE_NAME_UPPER, (env.BRANCH_NAME == "master") ? "current" : env.TAG)
          }
        }
      }
    }

    stage ('Create tags') {
      when {
        anyOf {
          branch 'master'
          branch 'rel_*'
        }
      }

      steps {
        withCredentials([string(credentialsId: 'gitlab--jenkins-token-10', variable: 'GITLAB_TOKEN')]) {
          versioning_createTag(env.GITLAB_TOKEN, env.gitlabSourceRepoName, sanitizedBranchName, env.GIT_COMMIT)
          versioning_updateVersionsRepo(env.GITLAB_TOKEN, env.gitlabSourceRepoName, sanitizedBranchName, env.gitlabSourceNamespace)
        }
      }
    }
  }

  post {
    regression {
      notification('regression', env.SERVICE_NAME)
    }

    fixed {
      notification('fixed', env.SERVICE_NAME)
    }

    success {
      notification('success', env.SERVICE_NAME)
    }
  }
}
